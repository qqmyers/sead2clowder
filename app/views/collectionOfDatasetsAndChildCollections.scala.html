@(datasetsInCollection: List[models.Dataset],childCollections : List[models.Collection],
  collection: models.Collection,
  previewers: List[Previewer],
  parentCollections : Option[List[models.Collection]],
  collectionSpaces: Option[List[ProjectSpace]])(implicit flash: play.api.mvc.Flash, user: Option[models.User])

@import models.ResourceRef
@import models.UUID
@import api.Permission

@showPreview(name: String, url: String, collection_id: String) = {
<script>
    var Configuration = {};
    Configuration.tab = "#previewer_@name";
    Configuration.url = "@url";
    Configuration.collection_id = "@collection_id";
</script>
<script type="text/javascript" src="@(url)"></script>
}

@main("Collection") {

<script src="@routes.Assets.at("javascripts/errorRedirect.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/collectionDatasetsList.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/collectionChildCollectionsList.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/collectionListProcess.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("javascripts/htmlEncodeDecode.js")" language="javascript"></script>


	<div class="row">
			<!-- left column -->
		<div class="col-md-8 col-right-border">

			<div id="coll-title" class="page-header caption break-word">
				<h1 id ="collectiontitle" class="inline">@Html(collection.name)</h1>
				@if(Permission.checkPermission(Permission.EditCollection, ResourceRef(ResourceRef.collection, collection.id))) {
					<h3 id="h-edit-title" class="hiddencomplete">
						<a id="edit-title" href="javascript:updateTitle()" edit="Click to edit title">
							<span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
						</a>
					</h3>
				}

			</div>
			<div class="row">
				<div class="col-md-12">
							<dl class="dl-horizontal">
									<dt>Author:</dt>
									<dd>
										<a href= "@routes.Profile.viewProfile(collection.author.email)"> @collection.author.fullName </a>
									</dd>
								<dt>Description:</dt>
								<dd id="aboutdesc"><p id="collection_desc"  class="inline">@Html(collection.description)</p>
									@if(Permission.checkPermission(Permission.EditCollection, ResourceRef(ResourceRef.collection, collection.id))) {
										<a class="hiddencomplete" id="edit-description" href="javascript:updateDescription()" title ="Click to edit description">
											<span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
										</a>
									}
								</dd>
							</dl>
					<div class="col-md-12">



							<!-- If user can delete, the button is enabled, otherwise the button is present but disabled to provide consistent UE. -->
							@if(Permission.checkPermission(Permission.DeleteCollection, ResourceRef(ResourceRef.collection, collection.id))){
									<button id="deleteButton" onclick="removeCollectionAndRedirect('@(collection.id)','@(routes.Collections.list(""))')"
											style="margin-right:15px;" class="btn btn-link btn-sm" title="Delete Collection but not Enclosed Datasets">
									<span class="glyphicon glyphicon-trash"></span> Delete</button>
							} else {
									<button disabled id="deleteButton" onclick="removeCollectionAndRedirect('@(collection.id)','@(routes.Collections.list(""))')"
											style="margin-right:15px;" class="btn btn-link btn-sm" title="Delete Collection but not Enclosed Datasets">
									<span class="glyphicon glyphicon-trash"></span> Delete</button>
							}
							@if(user.isDefined) {
								@if(!collection.followers.contains(user.get.id)) {
									<button id="followButton"
									class="btn btn-link followButton btn-sm"
									objectId="@collection.id"
									objectName="@collection.name"
									objectType="collection"><span class="glyphicon glyphicon-star"></span> Follow
									</button>
								} else {
									<button id="followButton"
									class="btn btn-link followButton btn-sm"
									objectId="@collection.id"
									objectName="@collection.name"
									objectType="collection"><span class="glyphicon glyphicon-star-empty"></span> Unfollow
									</button>
								}
							}
						</div>
							<div style="clear: both;"></div>

							<div id="recommendPanel"
									class="panel panel-default"
									style="margin-top: 20px; display : none;">
								<div class="panel-heading">
									<h4 class="panel-title">
										<a data-parent="#accordion"
										href="#collapseThree"
										aria-expanded="true"
										style="float:left;">
											Also follow these?
										</a>
										<a style="float:right;" href="javascript:$('#recommendPanel').slideToggle('slow');">x</a>
										<div style="clear : both;"></div>
									</h4>
								</div>
								<div id="collapseThree" class="panel-collapse collapse in" aria-expanded="true">
									<div id="recommendDiv" class="panel-body">
									</div>
								</div>
							</div>

							<script src="@routes.Assets.at("javascripts/recommendation.js")" type="text/javascript"></script>
							<script>
								$(document).on('click', '.followButton', function() {
									var id = $(this).attr('objectId');
									var name = $(this).attr('objectName');
									var type = $(this).attr('objectType');
									if ($(this).attr('id') === '') {
									  followHandler.call(this, jsRoutes, id, name, type, undefined, undefined);
									} else {
									  followHandler.call(this, jsRoutes, id, name, type, function(data) {
											recommendationHandler(jsRoutes, $('#recommendPanel'), $('#recommendDiv'),
														  data['recommendations']);
										}, undefined);
									}
								});
							</script>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					@for((p,i) <- previewers.zipWithIndex) {
						<h3>@p.id</h3>
						<div class="previewDiv" id="previewer_@(p.id)_@i"></div>
						@showPreview(p.id + "_" + i, routes.Assets.at("javascripts/previewers") + "/" + p.id + "/" + p.main, collection.id.stringify)
					}
				</div>
			</div>
			<div class="row">
			<div class="col-md-12">
				<h3>Child collections in the collection</h3>
					@childCollections.map { childCollection =>
						<div class="panel panel-default" id="@childCollection.id">
							<div class="panel-body">
								<div class="row">
									<div class="col-md-2 col-sm-2 col-lg-2">
										@if(!childCollection.thumbnail_id.isEmpty){<img src="@(routes.Files.thumbnail(UUID(childCollection.thumbnail_id.toString().substring(5,childCollection.thumbnail_id.toString().length-1))))" alt="Thumbnail of @Html(childCollection.name)" width="120">}
									</div>
									<div class="col-md-10 col-sm-10 col-lg-10">
										<div><a href="@(routes.Collections.collection(childCollection.id))">@Html(childCollection.name)</a></div>
										<div>@Html(childCollection.description)</div>
										<div>@childCollection.created.format("MMM dd, yyyy")</div>
										@if(user.isDefined) {
											<div>
												@if(Permission.checkPermission(Permission.DeleteCollection, ResourceRef(ResourceRef.collection, collection.id))){
													<a onclick="removeChildCollection('@(childCollection.id.toString)','@(collection.id.toString)',event)" title="Remove the Child Collection">
														<span class="glyphicon glyphicon-trash"></span></a>
												}
											</div>
										}
									</div>
								</div>
							</div>
						</div>

					}

				<ul class="pager" id="datasetsPager">
					<li class="previous" id="datasetsPagerPrev" style="visibility:hidden;"><a class="btn btn-link" href="#!"><span class="glyphicon glyphicon-chevron-left"></span> Previous</a></li>
					<li class ="next" id="datasetsPagerNext" style="visibility:hidden;"><a class="btn btn-link" href="#!">Next <span class="glyphicon glyphicon-chevron-right"></span></a></li>
				</ul>
			</div>
			<div class="col-md-12">
				<h3>Datasets in the collection</h3>
					@datasetsInCollection.map { dataset =>
						<div class="panel panel-default" id="@dataset.id">
							<div class="panel-body">
								<div class="row">
									<div class="col-md-2 col-sm-2 col-lg-2">
										@if(!dataset.thumbnail_id.isEmpty){<img src="@(routes.Files.thumbnail(UUID(dataset.thumbnail_id.toString().substring(5,dataset.thumbnail_id.toString().length-1))))" alt="Thumbnail of @Html(dataset.name)" width="120">}
									</div>
									<div class="col-md-10 col-sm-10 col-lg-10">
										<div><a href="@(routes.Datasets.dataset(dataset.id))">@Html(dataset.name)</a></div>
										<div>@Html(dataset.description)</div>
										<div>@dataset.created.format("MMM dd, yyyy")</div>
										@if(user.isDefined) {
											<div>
												@if(Permission.checkPermission(Permission.DeleteCollection, ResourceRef(ResourceRef.collection, collection.id))){
													<a onclick="removeDataset('@(dataset.id.toString)',event)" title="Detach the Dataset">
														<span class="glyphicon glyphicon-trash"></span></a>
												}
											</div>
										}
									</div>
								</div>
							</div>
						</div>

					}

				<ul class="pager" id="datasetsPager">
					<li class="previous" id="datasetsPagerPrev" style="visibility:hidden;"><a class="btn btn-link" href="#!"><span class="glyphicon glyphicon-chevron-left"></span> Previous</a></li>
					<li class ="next" id="datasetsPagerNext" style="visibility:hidden;"><a class="btn btn-link" href="#!">Next <span class="glyphicon glyphicon-chevron-right"></span></a></li>
				</ul>

			</div>
		</div>
		</div>
	<!-- right column -->
	<div class="col-md-4">
		@spaces.spaceAllocation(collection.id,ResourceRef.collection, collectionSpaces.getOrElse(List.empty))
		<br/>
		@collections.parentAllocation(collection,collection.id,ResourceRef.collection, parentCollections.getOrElse(List.empty))
		<br />
		@if(user.isDefined && collectionSpaces.isDefined && !collectionSpaces.get.isEmpty){
			<div id="collection-users">
				<a href="@routes.Collections.users(collection.id)">
					<span class="glyphicon glyphicon-hand-right"></span> Users with access to the collection
				</a>
				<br /> <br />
				<div class="alert-danger inner-item">
				@flash.get("error")
				</div>
			</div>
		}
	</div>
	</div>

<script language="javascript">
	@if(user.isDefined) {
		@if(!(user.get.identityId.userId.equals(collection.author.identityId.userId))) {
			$(".requiresLogin:not(.requiresLoginCommunity)").css("display","none");
		}
	}
	@if(!user.isDefined) {
		$(".requiresLogin").css("display","none");
	}


	var collectionId = "@collection.id.stringify";
	var cur_title;
	function updateTitle() {
	 cur_title = $('#collectiontitle').text();
	 $('<div class="inline edit_title_div"> </span>').insertAfter($('#collectiontitle'));
	 $('.edit_title_div').append('<input type = "text" id="title_input" class="form-control"/>');
	 $('.edit_title_div').append('<div class="hiddencomplete" id="title-error"> <span class="error"> Title is required </span> </div>');
	 $('.edit_title_div').append('<button id="update_title" class="btn btn-sm btn-primary btn-margins" onclick="saveTitle()"> <span class="glyphicon glyphicon-send"></span> Save </button>');
	 $('.edit_title_div').append('<button id="cancel_title" class="btn btn-sm btn-default btn-margins edit-tab" onclick="cancelTitle()"> <span class="glyphicon glyphicon-remove"></span> Cancel </button>');

	 $('#title_input').val(cur_title);
	 $('#collectiontitle').text("");
	 $('#h-edit-title').css("display", "none");
	 $('#h-edit-title').addClass("hiddencomplete");

	}

	function saveTitle() {
		if($('#title_input').val().length < 1) {
			$('#title-error').show();
			return false;
		} else {
			$('#title-error').addClass('hiddencomplete');
		}
		var name = $('#title_input').val();
		var encName = htmlEncode(name);
		jsonData = JSON.stringify({"name": encName});

		var request = jsRoutes.api.Collections.updateCollectionName(collectionId).ajax({
			data: jsonData,
			type: 'PUT',
			contentType: "application/json"
		});

		request.done(function(response, textStatus, jqXHR) {
			$('#collectiontitle').text(encName.replace(/\n/g, "<br>"));
            $('.edit_title_div').remove();
			$('#collectiontitle').css("display", "inline");
			$('#h-edit-title').removeClass("inline");
			$('#h-edit-title').css("display", "");
			$('#coll-title').mouseleave();
		});

		request.fail(function(jqXHR, textStatus, errorThrown) {
			console.error("The following error occurred: " + textStatus, errorThrown);
			var errMsg = "Yoy must be logged in to update the information about a collection.";
			if(!checkErrorAndRedirect(jqXHR, errMsg)) {
				notify("The collection information was not updated due to: "+ errorThrown, "error");
			}
		});

	}
	function cancelTitle() {
		$('#collectiontitle').text(cur_title);
        $('.edit_title_div').remove();
		$('#collectiontitle').css("display", "inline");
		$('#h-edit-title').removeClass("inline");
		$('#h-edit-title').css("display", "");
		$('#coll-title').mouseleave();
	}

	var cur_description;

	function updateDescription() {
		cur_description = $('#collection_desc').html().trim();
		$('<div class = "edit_desc"></div>').insertAfter($('#collection_desc'));
		$(".edit_desc").append('<textarea type ="text" id = "desc_input" class="form-control"/>');
		$(".edit_desc").append('<br/>');
		$(".edit_desc").append('<button id = "update_desc" class = "btn btn-sm btn-primary" onclick = "saveDescription()"> <span class="glyphicon glyphicon-send"></span>  Save </button>');
		$(".edit_desc").append('<button id = "cancel_desc" class = "btn btn-default btn-sm edit-tab" onclick = "cancelDescription()"> <span class="glyphicon glyphicon-remove"></span>  Cancel </button>');
		$('#desc_input').val(cur_description.replace(new RegExp("<br>", "g"), "\n"));
		$('#collection_desc').text("");
		$('#edit-description').css("display", "none");
		$('#edit-description').addClass("hiddencomplete");
	}

	function saveDescription() {
		var description = $('#desc_input').val();
		var encDescription = htmlEncode(description);
		jsonData = JSON.stringify({"description": description});

		var request = jsRoutes.api.Collections.updateCollectionDescription(collectionId).ajax({
			data: jsonData,
			type: 'PUT',
			contentType: "application/json"
		});

		request.done(function(response, textStatus,jqXHR) {
			$('#collection_desc').html(encDescription.replace(/\n/g, "<br>"));
			$('.edit_desc').remove();
			$('#edit-description').css("display", "");
			$('#edit-description').removeClass("inline");
			$('#collection_desc').css("display", "inline");
		});

		request.fail(function(jqXHR, textStatus, errorThrown) {
			console.error("The following error occurred: " + textStatus, errorThrown);
			var errMsg = " You must be logged in to update the information about a collection.";
			if(!checkErrorAndRedirect(jqXHR, errMsg)) {
				notify("The collection information was not updated due to: " + errorThrown, "error");
			}
		});
	}

	function cancelDescription() {
		$('#collection_desc').html(cur_description);
		$('.edit_desc').remove();
		$('#edit-description').css("display", "");
		$('#edit-description').removeClass("inline");
		$('#collection_desc').css("display", "inline");
	}

	$(document).ready(function(){
		if(@collection.spaces.size < 1 ) {
			$('#collection-users').hide();
		}
		if(@Permission.checkPermission(Permission.EditCollection, ResourceRef(ResourceRef.collection, collection.id))) {
			    $(document).on('mouseenter', '#coll-title', function() {
                    $('#h-edit-title').removeClass("hiddencomplete");
                    $('#h-edit-title').addClass("inline");
                 }).on('mouseleave', '#coll-title', function() {
                    $('#h-edit-title').removeClass("inline");
                    $('#h-edit-title').addClass("hiddencomplete");
                 });

                 $(document).on('mouseenter', '#aboutdesc', function() {
                    $('#edit-description').removeClass("hiddencomplete");
                    $('#edit-description').addClass("inline");
                 }).on('mouseleave', '#aboutdesc', function() {
                    $('#edit-description').removeClass("inline");
                    $('#edit-description').addClass("hiddencomplete");
                 });
		}

	});
</script>
    <script src="@routes.Assets.at("javascripts/handlebars-v1.3.0.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/handlebars-loader.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/spaceModify.js")" type="text/javascript"></script>
	<script src="@routes.Assets.at("javascripts/collectionModify.js")" type="text/javascript"></script>

}
